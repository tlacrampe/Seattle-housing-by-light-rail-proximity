---
title: "Seattle Housing Prices: Assesing the effects of acessibility to public goods"
author: "Ahmed Almotaileq, Abigail Edelmen, Christopher Lacrampe"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  html_document:
    code_folding: hide
    highlight: tango
    theme: yeti
    toc: yes
---

***

#### Importing the Libraries

```{r, message = FALSE, warning = FALSE}
rm(list=ls(all=TRUE)) # clears working environment
library('tidyverse')  # bundle of packages useful for datamanipulation and organization
library('stargazer')  # package useful in outputting results of statistical models
library('knitr')      # package useful for formatting markdown files to html
library('lmtest')     # has functions for BP Test
library('sandwich')   # has functions for White TestT
library('geosphere')  # has functions for location manipulaton
```

The data for this project was collected from: 

1. Housing data: [Redfin](https://www.redfin.com/city/16163/WA/Seattle) on February 20th, 2018

2. Public goods' locations filtered from [Seattle.gov's](https://data.seattle.gov/Community/My-Neighborhood-Map/82su-5fxf/data) "My Neighborhood Map" collection.
    + Light rail data:   [Seattle.gov](https://data.seattle.gov/Community/Light-Rail-Map/5f4s-t4jf/data) on February 20th, 2018
    + Public parks data: [Seattle.gov](https://data.seattle.gov/Community/Parks-Map/rbbt-rarz) on February 23, 2018.
    + Public schools data: [Seattle.gov](https://data.seattle.gov/Community/Schools-Map/2tje-83f6) on February 23, 2018.
    + Public hospital data: [Seattle.gov](https://data.seattle.gov/Community/Hospitals/khp7-mz6q) on February 23, 2018.

#### Importing and Cleaning the Data

```{r}
redfinDat <- read.csv("redfin_2018-02-20-12-58-37_Seattle.csv")
lightRailDat <- read.csv("Light_Rail_Map.csv", stringsAsFactors = FALSE)
publicParkDat <- read.csv("Parks_Map.csv", stringsAsFactors = FALSE)
publicSchoolDat <- read.csv("Schools_Map.csv", stringsAsFactors = FALSE)
publicHospitalDat <- read.csv("Hospitals.csv", stringsAsFactors = FALSE)

# Removing uneeded colums
redfinDat <- subset(redfinDat, select = -c(SOLD.DATE,NEXT.OPEN.HOUSE.START.TIME,NEXT.OPEN.HOUSE.END.TIME, URL..SEE.http...www.redfin.com.buy.a.home.comparative.market.analysis.FOR.INFO.ON.PRICING., SOURCE, MLS.,FAVORITE, INTERESTED))

# Adds UW light rail station
uwStation <- list(FEATUREITEM_ID = NA, City.Feature = "Light Rail", Common.Name = as.factor("UW Station"), Address = NA, Website = NA, Longitude = -122.3038, Latitude = 47.6498, Location = "(47.6498, 122.3038)")
lightRailDat = rbind(lightRailDat, uwStation, stringsAsFactors=FALSE)
```

***

##### Special thanks to stack overflow user eclark for providing the framework for the functions used to calculate minimum distances. See his response to a simmilair query from  [this stackoverflow thread.](https://stackoverflow.com/questions/31732281/finding-minimum-distance-between-two-sets-of-points-in-two-sets-of-r)

#### Calculate the distance from the property location to the nearest light rail station, public park, public school, and public hospital using the following code chunks and minimizing the results from solving [Vincenty's Inverse Problem](https://en.wikipedia.org/wiki/Vincenty%27s_formulae):

More specificaly, minimizing the results for s where:

$\begin{aligned}
s = bA(\sigma - \Delta \sigma)
\end{aligned}$

and s is measured in meters, and accurate to 0.06mm.

```{r, warning = FALSE, results = "hide"}
# Preparing lat/lon dataframes for function
redfinCoords <- data.frame(location_id=redfinDat$ADDRESS,LATITUDE=redfinDat$LATITUDE,LONGITUDE=redfinDat$LONGITUDE)
lightRailCoords <- data.frame(location_id=lightRailDat$Common.Name,LATITUDE=lightRailDat$Latitude,LONGITUDE=lightRailDat$Longitude)

# Setting up DistLinkFun to find distance from property to closest lightrail station

DistLinkFun <- function(ID){
 TMP <- redfinCoords[redfinCoords$location_id==ID,]
 TMP1 <- distGeo(TMP[,3:2],lightRailCoords[,3:2]) # uses distGeo() function from geosphere package to calculate dist from lat and lon
 TMP2 <- data.frame(redfinCoordsID=ID,lightRailCoordsID=lightRailCoords[which.min(TMP1),1],distanceToLink=min(TMP1)) 
 print(ID)
 return(TMP2)
}

# Distance output of DistLinkFun parameters as redfinCoords$location_id, output is in meters
DistanceLinkMatrix <- rbind_all(lapply(redfinCoords$location_id, DistLinkFun))

# Taking distance variable and adding to original redfinDat dataframe
redfinDat$distanceToLink <- DistanceLinkMatrix$distanceToLink # values are in meters

# Adding the closest lightRail station variable to redfinDat
redfinDat$ClosestStation <- DistanceLinkMatrix$lightRailCoordsID
```

```{r, warning = FALSE, results = "hide"}
# preparing lat/lon dataframe for function
publicParkCoords <- data.frame(location_id=publicParkDat$Common.Name,LATITUDE=publicParkDat$Latitude,LONGITUDE=publicParkDat$Longitude)

# Setting up DistParkFun to find distance from property to closest public park

DistParkFun <- function(ID){
 TMP <- redfinCoords[redfinCoords$location_id==ID,]
 TMP1 <- distGeo(TMP[,3:2],publicParkCoords[,3:2]) # uses distGeo() function from geosphere package to calculate dist from lat and lon
 TMP2 <- data.frame(redfinCoordsID=ID,publicParkCoordsID=publicParkCoords[which.min(TMP1),1],distanceToPark=min(TMP1)) 
 print(ID)
 return(TMP2)
}

# Distance output of DistFun parameters as redfinCoords$location_id, output is in meters
DistanceParkMatrix <- rbind_all(lapply(redfinCoords$location_id, DistParkFun))

# Taking distance variable and adding to original redfinDat dataframe
redfinDat$distanceToPark <- DistanceParkMatrix$distanceToPark # values are in meters

# Adding the public park name variable to redfinDat
redfinDat$ClosestPark <- DistanceParkMatrix$publicParkCoordsID
```

```{r, warning = FALSE, results = "hide"}
# preparing lat/lon dataframe for function
publicSchoolCoords <- data.frame(location_id=publicSchoolDat$Common.Name,LATITUDE=publicSchoolDat$Latitude,LONGITUDE=publicSchoolDat$Longitude)

# Setting up DistSchoolFun to find distance from property to closest public school

DistSchoolFun <- function(ID){
 TMP <- redfinCoords[redfinCoords$location_id==ID,]
 TMP1 <- distGeo(TMP[,3:2],publicSchoolCoords[,3:2]) # uses distGeo() function from geosphere package to calculate dist from lat and lon
 TMP2 <- data.frame(redfinCoordsID=ID,publicSchoolCoordsID=publicSchoolCoords[which.min(TMP1),1],distanceToSchool=min(TMP1)) 
 print(ID)
 return(TMP2)
}

# Distance output of DistFun parameters as redfinCoords$location_id, output is in meters
DistanceSchoolMatrix <- rbind_all(lapply(redfinCoords$location_id, DistSchoolFun))

# Taking distance variable and adding to original redfinDat dataframe
redfinDat$distanceToSchool <- DistanceSchoolMatrix$distanceToSchool # values are in meters

# Adding the school name variable to redfinDat
redfinDat$ClosestSchool <- DistanceSchoolMatrix$publicSchoolCoordsID
```

```{r, warning = FALSE, results = "hide"}
# preparing lat/lon dataframe for function
publicHospitalCoords <- data.frame(location_id=publicHospitalDat$Common.Name,LATITUDE=publicHospitalDat$Latitude,LONGITUDE=publicHospitalDat$Longitude)

# Setting up DistHopsitalFun to find distance from property to closest public hospital

DistHospitalFun <- function(ID){
 TMP <- redfinCoords[redfinCoords$location_id==ID,]
 TMP1 <- distGeo(TMP[,3:2],publicHospitalCoords[,3:2]) # uses distGeo() function from geosphere package to calculate dist from lat and lon
 TMP2 <- data.frame(redfinCoordsID=ID,publicHospitalCoordsID=publicHospitalCoords[which.min(TMP1),1],distanceToHospital=min(TMP1)) 
 print(ID)
 return(TMP2)
}

# Distance output of DistFun parameters as redfinCoords$location_id, output is in meters
DistanceHospitalMatrix <- rbind_all(lapply(redfinCoords$location_id, DistHospitalFun))

# Taking distance variable and adding to original redfinDat dataframe
redfinDat$distanceToHospital <- DistanceHospitalMatrix$distanceToHospital # values are in meters

# Adding the hospital name variable to redfinDat
redfinDat$ClosestHospital <- DistanceHospitalMatrix$publicHospitalCoordsID
```

***

#### Preparing and outputting the models

```{r, results = "asis"}
mod1 <- lm(log(PRICE) ~ BEDS + BATHS + PROPERTY.TYPE + SQUARE.FEET + LOT.SIZE + YEAR.BUILT, data = redfinDat) # base model w/out the effects of distance to nearest public good
mod2 <- lm(log(PRICE) ~ BEDS + BATHS + PROPERTY.TYPE + SQUARE.FEET + LOT.SIZE + YEAR.BUILT + distanceToPark + distanceToSchool + distanceToHospital, data = redfinDat) # base model including public goods (excluding light rail station, allows for asessing if inclusion of light station is significant)
mod3 <- lm(log(PRICE) ~ BEDS + BATHS + PROPERTY.TYPE + SQUARE.FEET + LOT.SIZE + YEAR.BUILT + distanceToPark + distanceToSchool + distanceToHospital + distanceToLink, data = redfinDat) # model including distance to light rail station

# start creating models with interaction dummies to assess impact of distance thresholds
redfinDat$inter1 <- ifelse(redfinDat$distanceToLink <= 500, 1, 0) # threshold at 500 meters
redfinDat$inter1 <- as.factor(redfinDat$inter1)
mod4 <- lm(log(PRICE) ~ BEDS + BATHS + PROPERTY.TYPE + SQUARE.FEET + LOT.SIZE + YEAR.BUILT + distanceToPark + distanceToSchool + distanceToHospital + distanceToLink + distanceToLink*inter1, data = redfinDat)

redfinDat$inter2 <- ifelse(redfinDat$distanceToLink <= 1000, 1, 0) # threshold at 1000 meters
redfinDat$inter2 <- as.factor(redfinDat$inter2)
mod5 <- lm(log(PRICE) ~ BEDS + BATHS + PROPERTY.TYPE + SQUARE.FEET + LOT.SIZE + YEAR.BUILT + distanceToPark + distanceToSchool + distanceToHospital + distanceToLink + distanceToLink*inter2, data = redfinDat)

redfinDat$inter3 <- ifelse(redfinDat$distanceToLink <= 1500, 1, 0) # threshold at 1500 meters
redfinDat$inter3 <- as.factor(redfinDat$inter3)
mod6 <- lm(log(PRICE) ~ BEDS + BATHS + PROPERTY.TYPE + SQUARE.FEET + LOT.SIZE + YEAR.BUILT + distanceToPark + distanceToSchool + distanceToHospital + distanceToLink + distanceToLink*inter3, data = redfinDat)

stargazer(redfinDat, type = "html")

stargazer(mod1,mod2,mod3,mod4,mod5,mod6, type = "html",
          covariate.labels = c("No. of bedrooms", "No. of bathrooms", "Mobile/Manufactured Home", "Multi-Family(2-4 unit)", "Multi-Family(5+ unit)", "Other Property Type", "Single Family, Residential", "Townhouse", "Square Feet of property", "Lot Size (sqr feet)", "Year built", "Distance to nearest public green space (meters)", "Distance to nearest school (meters)", "Distance to nearest hospital (meters", "distance to nearest station (meters)", "D500", "Distance to nearest station interacted with D500", "D1000", "Distance to nearest station interacted with D1000", "D1500", "Distance to nearest station interacted with D1500"),
          column.labels = c("Model 1", "Model 2", "Model 3", "Model 4", "Model 5", "Model 6"),
          dep.var.labels.include = FALSE,
          dep.var.caption = "log(Price)")
```

